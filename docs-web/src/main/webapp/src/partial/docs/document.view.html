<div class="text-center" ng-show="!document && !error">
  <span class="fas fa-circle-notch fa-spin"></span>
</div>

<div ng-show="error" class="well-lg">
  <p class="text-center" ng-show="error.status == 404">
    <span class="fas fa-exclamation-triangle"></span>
    {{ 'document.view.not_found' | translate }}
  </p>
  <p class="text-center" ng-show="error.status == 403">
    <span class="fas fa-exclamation-triangle"></span>
    {{ 'document.view.forbidden' | translate }}
  </p>
</div>

<div ng-show="document">
  <div class="pull-right btn-group">
    <button class="btn btn-danger" ng-show="document.writable" ng-click="deleteDocument(document)"><span class="fas fa-trash"></span> {{ 'delete' | translate }}</button>
    <a href="#/document/edit/{{ document.id }}" ng-show="document.writable" class="btn btn-primary"><span class="fas fa-pencil-alt"></span> {{ 'edit' | translate }}</a>
  </div>

  <div class="pull-right dropdown" uib-dropdown>
    <button class="btn btn-default" uib-dropdown-toggle>
      <span class="fas fa-cloud-download-alt"></span>
      {{ 'export' | translate }}
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
      <li>
        <a ng-href="../api/file/zip?id={{ document.id }}">
          <span class="fas fa-download"></span>
          {{ 'document.view.download_files' | translate }}
        </a>
      </li>
      <li>
        <a href ng-click="exportPdf()">
          <span class="fas fa-file-pdf"></span>
          {{ 'document.view.export_pdf' | translate }}
        </a>
      </li>
    </ul>
    &nbsp;
  </div>

	<div class="page-header">
	  <h1>
      {{ document.title }}
      <small uib-tooltip="{{ 'document.last_updated' | translate: { date: document.update_date } }}">{{ document.create_date | date: dateFormat }}
      {{ 'document.view.by_creator' | translate }} <a href="#/user/{{ document.creator }}">{{ document.creator }}</a></small>
    </h1>

	  <p ng-show="document.writable">
	    <button class="btn btn-sm btn-info" ng-click="share()" ng-show="userInfo.username != 'guest'">
        <span class="fas fa-share"></span> {{ 'share' | translate }}
      </button>

      <span ng-repeat="share in document.acls | filter: { 'type': 'SHARE' }">
        <button class="btn btn-default btn-sm" ng-click="showShare(share)">
          <span class="fas fa-check"></span> {{ share.name ? share.name : 'shared' }}
        </button>
      </span>
	  </p>

	  <ul class="list-inline">
	    <li ng-repeat="tag in document.tags">
        <span class="label label-info pointer" ng-click="setSearch('tag:' + tag.name)" ng-style="{ 'background': tag.color }" invert-text-color="{{ tag.color }}">{{ tag.name }}</span>
      </li>
	  </ul>
	</div>

  <div class="row">
    <div class="col-md-9">
      <ul class="nav nav-tabs">
        <li ng-class="{ active: $state.current.name == 'document.view.content' }">
          <a href="#/document/view/{{ document.id }}/content">
            <span class="fas fa-file"></span> {{ 'document.view.content' | translate }}
          </a>
        </li>
        <li ng-class="{ active: $state.current.name == 'document.view.workflow' }">
          <a href="#/document/view/{{ document.id }}/workflow">
            <span class="fas fa-random"></span> {{ 'document.view.workflow' | translate }}
          </a>
        </li>
        <li ng-class="{ active: $state.current.name == 'document.view.permissions' }">
          <a href="#/document/view/{{ document.id }}/permissions">
            <span class="fas fa-user"></span> {{ 'document.view.permissions' | translate }}
          </a>
        </li>
        <li ng-class="{ active: $state.current.name == 'document.view.activity' }">
          <a href="#/document/view/{{ document.id }}/activity">
            <span class="fas fa-tasks"></span> {{ 'document.view.activity' | translate }}
          </a>
        </li>
      </ul>
      <div ui-view="tab"></div>
    </div>
    <div class="col-md-3">
      <div ng-show="document.route_step">
        <p class="page-header page-header-side">
          <span class="fas fa-random"></span>
          {{ 'document.view.workflow_current' | translate }}
        </p>
        <style>
          /* Rating Code adapted and sourced from https://codepen.io/hesguru/pen/BaybqXv */

          .experience {
            margin: 20px;
            padding: 10px;
            float: left;
            height: 46px;
            padding: 0 10px;
          }
          .experience:not(:checked) > input {
            position: absolute;
            top: -9999px;
          }
          .experience:not(:checked) > label {
            float: right;
            width: 1em;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            font-size: 20px;
            color: #ddd;
          }
          .experience:not(:checked) > label:before {
            content: "★ ";
          }
          .experience > input:checked ~ label {
            color: #5bc0de;
          }
          .experience:not(:checked) > label:hover,
          .experience:not(:checked) > label:hover ~ label {
            color: #46b8da;
          }

          .gpa {
            margin: 20px;
            float: left;
            height: 46px;
            padding: 0 10px;
          }
          .gpa:not(:checked) > input {
            position: absolute;
            top: -9999px;
          }
          .gpa:not(:checked) > label {
            float: right;
            width: 1em;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            font-size: 20px;
            color: #ddd;
          }
          .gpa:not(:checked) > label:before {
            content: "★ ";
          }
          .gpa > input:checked ~ label {
            color: #5bc0de;
          }
          .gpa:not(:checked) > label:hover,
          .gpa:not(:checked) > label:hover ~ label {
            color: #46b8da;
          }

          .skills {
            margin: 20px;
            float: left;
            height: 46px;
            padding: 0 10px;
          }
          .skills:not(:checked) > input {
            position: absolute;
            top: -9999px;
          }
          .skills:not(:checked) > label {
            float: right;
            width: 1em;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            font-size: 20px;
            color: #ddd;
          }
          .skills:not(:checked) > label:before {
            content: "★ ";
          }
          .skills > input:checked ~ label {
            color: #5bc0de;
          }
          .skills:not(:checked) > label:hover,
          .skills:not(:checked) > label:hover ~ label {
            color: #46b8da;
          }
        </style>
        <div class="text-center card">
          <p>{{ document.route_step.name }}</p>
          <p>
            <span class="fas fa-exchange-alt" ng-if="document.route_step.type == 'APPROVE'"></span>
            <span class="fas fa-check-circle" ng-if="document.route_step.type == 'VALIDATE'"></span>
            <span class="far fa-file" ng-if="document.route_step.type == 'RESUME_REVIEW'"></span>
            {{ 'workflow_type.' + document.route_step.type | translate }}
            <span class="label label-default"><acl data="document.route_step.target"></acl></span>
          </p>
          <p ng-show="document.route_step.transitionable">
            <div class="gpa" ng-show="document.route_step.type == 'VALIDATE'">
              <strong class="rating">GPA</strong><br>
              <input type="radio" id="gpastar5" name="gpa" value="5" />
              <label for="gpastar5" title="text">5 stars</label>
              <input type="radio" id="gpastar4" name="gpa" value="4" />
              <label for="gpastar4" title="text">4 stars</label>
              <input type="radio" id="gpastar3" name="gpa" value="3" />
              <label for="gpastar3" title="text">3 stars</label>
              <input type="radio" id="gpastar2" name="gpa" value="2" />
              <label for="gpastar2" title="text">2 stars</label>
              <input type="radio" id="gpastar1" name="gpa" value="1" />
              <label for="gpastar1" title="text">1 star</label>
            </div>  
            <div class="skills" ng-show="document.route_step.type == 'VALIDATE'">
              <strong class="rating">Skills</strong><br>
              <input type="radio" id="skillsstar5" name="skills" value="5" />
              <label for="skillsstar5" title="text">5 stars</label>
              <input type="radio" id="skillsstar4" name="skills" value="4" />
              <label for="skillsstar4" title="text">4 stars</label>
              <input type="radio" id="skillsstar3" name="skills" value="3" />
              <label for="skillsstar3" title="text">3 stars</label>
              <input type="radio" id="skillsstar2" name="skills" value="2" />
              <label for="skillsstar2" title="text">2 stars</label>
              <input type="radio" id="skillsstar1" name="skills" value="1" />
              <label for="skillsstar1" title="text">1 star</label>
            </div> 
            <div class="experience" ng-show="document.route_step.type == 'VALIDATE'">
              <strong class="rating">Experience</strong><br>
              <input type="radio" id="experiencestar5" name="experience" value="5" />
              <label for="experiencestar5" title="text">5 stars</label>
              <input type="radio" id="experiencestar4" name="experience" value="4" />
              <label for="experiencestar4" title="text">4 stars</label>
              <input type="radio" id="experiencestar3" name="experience" value="3" />
              <label for="experiencestar3" title="text">3 stars</label>
              <input type="radio" id="experiencestar2" name="experience" value="2" />
              <label for="experiencestar2" title="text">2 stars</label>
              <input type="radio" id="experiencestar1" name="experience" value="1" />
              <label for="experiencestar1" title="text">1 star</label>
            </div> 
          
            <textarea ng-model="workflowComment" maxlength="500" class="form-control mb-10"
                      ng-attr-placeholder="{{ 'document.view.workflow_comment' | translate }}"></textarea>
            <span class="btn btn-primary"
                  ng-show="document.route_step.type == 'VALIDATE'"
                  ng-click="validateWorkflow('VALIDATED')">
              {{ 'workflow_transition.VALIDATED' | translate }}
            </span>
            <span class="btn btn-success"
                  ng-show="document.route_step.type == 'APPROVE'"
                  ng-click="validateWorkflow('APPROVED')">
              {{ 'workflow_transition.APPROVED' | translate }}
            </span>
            <span class="btn btn-danger"
                  ng-show="document.route_step.type == 'APPROVE'"
                  ng-click="validateWorkflow('REJECTED')">
              {{ 'workflow_transition.REJECTED' | translate }}
            </span>
            <span class="btn btn-danger"
                  ng-show="document.route_step.type == 'RESUME_REVIEW'"
                  ng-click="validateWorkflow('SAVE')">
              {{ 'workflow_transition.RESUME_REVIEW' | translate }}
            </span>
          </p>
        </div>
      </div>

  

      <p class="page-header page-header-side">
        <span class="fas fa-comments"></span>
        {{ 'document.view.comments' | translate }}
      </p>

      <div ng-show="!comments || comments.length == 0" class="text-center text-muted">
        <h1 class="fas fa-comments"></h1>
        <p ng-show="!comments && !commentsError">{{ 'loading' | translate }}</p>
        <p ng-show="comments.length == 0">{{ 'document.view.no_comments' | translate }}</p>
        <p ng-show="!comments && commentsError">{{ 'document.view.error_loading_comments' | translate }}</p>
      </div>

      <div ng-repeat="comment in comments" class="media" style="overflow: hidden">
        <div class="pull-left">
          <img ng-src="https://www.gravatar.com/avatar/{{ comment.creator_gravatar }}?s=40&d=identicon" class="media-object" />
        </div>
        <div class="media-body">
          <strong>{{ comment.creator }}</strong>
          <p>
            {{ comment.content }}<br />
            <span class="text-muted">{{ comment.create_date | timeAgo: dateTimeFormat }}</span>
          <span class="text-muted pull-right btn-link pointer"
                ng-show="document.writable || userInfo.username == comment.creator"
                ng-click="deleteComment(comment)">
            <span class="fas fa-times"></span>
          </span>
          </p>
        </div>
      </div>

      <div>
        <p>GPA</p>
      </div>

      <form ng-submit="addComment()">
        <div class="form-group">
          <label class="sr-only" for="commentInput">{{ 'document.view.add_comment' | translate }}</label>
          <input type="text" class="form-control" id="commentInput" ng-model="comment" ng-attr-placeholder="{{ 'document.view.add_comment' | translate }}">
        </div>
      </form>
    </div>
  </div>
</div>